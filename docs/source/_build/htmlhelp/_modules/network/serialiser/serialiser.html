<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=cp1252" />
    
    <title>network.serialiser.serialiser</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="top" title="PyAuthServer 1.0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyAuthServer 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <h1>Source code for network.serialiser.serialiser</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">Struct</span><span class="p">,</span> <span class="n">pack</span><span class="p">,</span> <span class="n">unpack_from</span>

<span class="kn">from</span> <span class="nn">..type_flag</span> <span class="kn">import</span> <span class="n">TypeFlag</span>
<span class="kn">from</span> <span class="nn">..handlers</span> <span class="kn">import</span> <span class="n">register_handler</span><span class="p">,</span> <span class="n">IHandler</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;bits_to_bytes&#39;</span><span class="p">,</span> <span class="s">&#39;next_or_equal_power_of_two&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">execute_and_return_pair</span><span class="p">(</span><span class="n">function_string</span><span class="p">,</span> <span class="n">locals_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create function from definition string.</span>

<span class="sd">    :param locals_dict: locals dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_locals</span> <span class="o">=</span> <span class="n">locals_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">exec</span><span class="p">(</span><span class="n">function_string</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="n">original_locals</span><span class="p">)</span>

    <span class="c"># Find the added function</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">original_locals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">locals_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">break</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find defined function. This shouldn&#39;t happen&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_key</span><span class="p">,</span> <span class="n">original_locals</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">build_struct_handler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">character_format</span><span class="p">,</span> <span class="n">order_format</span><span class="o">=</span><span class="s">&quot;!&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create handler for data with struct formatting</span>

<span class="sd">    :param name: name of handler class</span>
<span class="sd">    :param character_format: format string of handler</span>
<span class="sd">    :param order_format: format string of byte order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">struct_obj</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="n">order_format</span> <span class="o">+</span> <span class="n">character_format</span><span class="p">)</span>
    <span class="n">format_size</span> <span class="o">=</span> <span class="n">struct_obj</span><span class="o">.</span><span class="n">size</span>

    <span class="n">methods</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;&quot;&quot;def __init__(self):</span><span class="se">\n\t</span><span class="s">print(&#39;WTF&#39;)&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def unpack_from(bytes_string, offset=0, unpacker=struct_obj.unpack_from):\n\t</span>
<span class="sd">               return unpacker(bytes_string, offset)[0], {format_size}&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def size(bytes_string=None):\n\treturn {format_size}&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def pack_multiple(value, count, pack=pack, character_format=character_format):\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;return pack(&#39;{order_format}&#39; + &#39;{character_format}&#39; * count, *value)&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def unpack_multiple(bytes_string, count, offset=0, unpack_from=unpack_from):\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;data = unpack_from(&#39;{order_format}&#39; + &#39;{character_format}&#39; * count, bytes_string, offset)\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;return data, {format_size} * count&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;pack=struct_obj.pack&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">locals_</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">method_string</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">formatted_string</span> <span class="o">=</span> <span class="n">method_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">locals_</span><span class="p">)</span>
        <span class="n">value_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">execute_and_return_pair</span><span class="p">(</span><span class="n">formatted_string</span><span class="p">,</span> <span class="n">locals_</span><span class="p">)</span>

        <span class="n">cls_dict</span><span class="p">[</span><span class="n">value_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(),</span> <span class="n">cls_dict</span><span class="p">)</span>


<span class="n">UInt32</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt32&quot;</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">)</span>
<span class="n">UInt16</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt16&quot;</span><span class="p">,</span> <span class="s">&quot;H&quot;</span><span class="p">)</span>
<span class="n">UInt64</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt64&quot;</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">)</span>
<span class="n">UInt8</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt8&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">)</span>
<span class="n">Int32</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt32&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">Int16</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt16&quot;</span><span class="p">,</span> <span class="s">&quot;h&quot;</span><span class="p">)</span>
<span class="n">Int64</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt64&quot;</span><span class="p">,</span> <span class="s">&quot;q&quot;</span><span class="p">)</span>
<span class="n">Int8</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;UInt8&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
<span class="n">Float32</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;Float32&quot;</span><span class="p">,</span> <span class="s">&quot;f&quot;</span><span class="p">)</span>
<span class="n">Float64</span> <span class="o">=</span> <span class="n">build_struct_handler</span><span class="p">(</span><span class="s">&quot;Float64&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">)</span>


<span class="n">int_handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">UInt8</span><span class="p">,</span> <span class="n">UInt16</span><span class="p">,</span> <span class="n">UInt32</span><span class="p">,</span> <span class="n">UInt64</span><span class="p">]</span>
<span class="n">size_to_int_handler</span> <span class="o">=</span> <span class="p">{</span><span class="n">packer</span><span class="o">.</span><span class="n">size</span><span class="p">():</span> <span class="n">packer</span> <span class="k">for</span> <span class="n">packer</span> <span class="ow">in</span> <span class="n">int_handlers</span><span class="p">}</span>


<div class="viewcode-block" id="bits_to_bytes"><a class="viewcode-back" href="../../../network.serialiser.serialiser.html#network.serialiser.serialiser.bits_to_bytes">[docs]</a><span class="k">def</span> <span class="nf">bits_to_bytes</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines how many bytes are required to pack a number of bits</span>

<span class="sd">    :param bits: number of bits required</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ceil</span><span class="p">(</span><span class="n">bits</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="next_or_equal_power_of_two"><a class="viewcode-back" href="../../../network.serialiser.serialiser.html#network.serialiser.serialiser.next_or_equal_power_of_two">[docs]</a><span class="k">def</span> <span class="nf">next_or_equal_power_of_two</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return next power of 2 greater than or equal to value&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">|=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span>
        <span class="n">shift</span> <span class="o">*=</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span>

</div>
<span class="k">def</span> <span class="nf">_handler_from_bit_length</span><span class="p">(</span><span class="n">total_bits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the correct integer handler for a given number of bits</span>

<span class="sd">    :param total_bits: total number of bits required</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">bits_to_bytes</span><span class="p">(</span><span class="n">total_bits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_handler_from_byte_length</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handler_from_byte_length</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the smallest handler needed to pack a number of bytes</span>

<span class="sd">    :param total_bytes: number of bytes needed to pack</span>
<span class="sd">    :rtype: :py:class:`network.serialiser.IDataHandler`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rounded_bytes</span> <span class="o">=</span> <span class="n">next_or_equal_power_of_two</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">size_to_int_handler</span><span class="p">[</span><span class="n">rounded_bytes</span><span class="p">]</span>

    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Integer too large to pack: {} bytes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">err</span>

    <span class="k">return</span> <span class="n">packer</span>


<span class="k">def</span> <span class="nf">_handler_from_int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the smallest integer packer capable of packing a given integer</span>

<span class="sd">    :param value: integer value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_handler_from_bit_length</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">BoolHandler</span><span class="p">(</span><span class="n">UInt8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for boolean type&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">unpack_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytes_string</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unpack_from</span><span class="o">=</span><span class="n">UInt8</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">):</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">unpack_from</span><span class="p">(</span><span class="n">bytes_string</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">size</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">unpack_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytes_string</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unpack_multiple</span><span class="o">=</span><span class="n">UInt8</span><span class="o">.</span><span class="n">unpack_multiple</span><span class="p">):</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_multiple</span><span class="p">(</span><span class="n">bytes_string</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">],</span> <span class="n">size</span>


<span class="k">class</span> <span class="nc">_BytesHandler</span><span class="p">:</span>

    <span class="n">classes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="n">header_max_value</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;max_length&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_cls</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">header_max_value</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">packer</span> <span class="o">=</span> <span class="n">_handler_from_int</span><span class="p">(</span><span class="n">header_max_value</span><span class="p">)</span>

            <span class="n">methods</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;&quot;&quot;def unpack_from(bytes_string, offset=0, *, unpacker=packer.unpack_from):</span><span class="se">\n\t</span><span class="s">&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;length, length_size = unpacker(bytes_string, offset)\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;end_index = length + length_size\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;value = bytes_string[length_size + offset: end_index + offset]\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;return value, end_index&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def pack_multiple(value, count, pack_lengths=packer.pack_multiple):\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;lengths = [len(x) for x in value]\n\tpacked_lengths = pack_lengths(lengths, len(lengths))\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;return packed_lengths + b&#39;&#39;.join(value)&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def unpack_multiple(bytes_string, count, offset=0, unpack_lengths=packer.unpack_multiple):&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;\n\t_offset=offset\n\tlengths, length_offset=unpack_lengths(bytes_string, &quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;count, offset)\n\toffset += length_offset\n\tdata = []\n\tfor length in lengths:\n\t\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;data.append(bytes_string[offset: offset+length])\n\t\toffset += length\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;return data, offset - _offset&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def size(bytes_string, unpacker=packer.unpack_from):\n\t&quot;&quot;&quot;</span>
               <span class="sd">&quot;&quot;&quot;length, length_size = unpacker(bytes_string)\n\treturn length + length_size&quot;&quot;&quot;</span><span class="p">,</span>
               <span class="sd">&quot;&quot;&quot;def pack(bytes_string, packer=packer.pack):\n\treturn packer(len(bytes_string)) + bytes_string&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">locals_</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">method_string</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="n">value_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">execute_and_return_pair</span><span class="p">(</span><span class="n">method_string</span><span class="p">,</span> <span class="n">locals_</span><span class="p">)</span>

                <span class="n">cls_dict</span><span class="p">[</span><span class="n">value_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&quot;BytesHandler&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">cls_dict</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">header_max_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cls</span>

        <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">class</span> <span class="nc">_StringHandler</span><span class="p">:</span>

    <span class="n">classes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="n">header_max_value</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;max_length&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_cls</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">header_max_value</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">packer</span> <span class="o">=</span> <span class="n">_handler_from_int</span><span class="p">(</span><span class="n">header_max_value</span><span class="p">)</span>

            <span class="n">methods</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;&quot;&quot;def unpack_from(bytes_string, offset=0, *, unpacker=packer.unpack_from):</span>
<span class="s">                length, length_size = unpacker(bytes_string, offset)</span><span class="se">\n\t</span><span class="s"></span>
<span class="s">                end_index = length + length_size</span><span class="se">\n\t</span><span class="s"></span>
<span class="s">                value = bytes_string[length_size + offset: end_index + offset]</span><span class="se">\n\t</span><span class="s"></span>
<span class="s">                return value.decode(), end_index&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="sd">&quot;&quot;&quot;def pack(string_, packer=packer.pack):\n\treturn packer(len(string_)) + string_.encode()&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="sd">&quot;&quot;&quot;def pack_multiple(value, count, pack_lengths=packer.pack_multiple):\n\t&quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;lengths = [len(x) for x in value]\n\tpacked_lengths = pack_lengths(lengths, len(lengths))\n\t&quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;return packed_lengths + &#39;&#39;.join(value).encode()&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="sd">&quot;&quot;&quot;def unpack_multiple(bytes_string, count, offset=0, unpack_lengths=packer.unpack_multiple):&quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;\n\t_offset=offset\n\tlengths, length_offset=unpack_lengths(bytes_string, count, offset)\n\t&quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;offset += length_offset\n\tdata = []\n\tfor length in lengths:\n\t\t&quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;data.append(bytes_string[offset: offset+length].decode())\n\t\toffset += length\n\t&quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;return data, offset - _offset&quot;&quot;&quot;</span><span class="p">,)</span>

            <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">locals_</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">method_string</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="n">value_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">execute_and_return_pair</span><span class="p">(</span><span class="n">method_string</span><span class="p">,</span> <span class="n">locals_</span><span class="p">)</span>

                <span class="n">cls_dict</span><span class="p">[</span><span class="n">value_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&quot;StringHandler&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">cls_dict</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">header_max_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cls</span>

        <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">def</span> <span class="nf">_float_handler</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return  the correct float handler using meta information from a given type_flag&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Float64</span> <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;max_precision&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">Float32</span>


<span class="k">def</span> <span class="nf">_int_handler</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the correct int handler using meta information from a given type_flag&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s">&quot;max_value&quot;</span> <span class="ow">in</span> <span class="n">flag</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="n">_handler_from_int</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;max_value&quot;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="n">_handler_from_bit_length</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;max_bits&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">def</span> <span class="nf">_bool_handler</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BoolHandler</span>



<span class="c"># Register handlers for native types</span>
<span class="n">register_handler</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">_StringHandler</span><span class="p">)</span>
<span class="n">register_handler</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">_BytesHandler</span><span class="p">)</span>
<span class="n">register_handler</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">_int_handler</span><span class="p">)</span>
<span class="n">register_handler</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">_bool_handler</span><span class="p">)</span>
<span class="n">register_handler</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">_float_handler</span><span class="p">)</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyAuthServer 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Angus Hollands.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>